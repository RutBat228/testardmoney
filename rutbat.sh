#!/bin/bash
REPO_URL="https://github.com/RutBat228/rutapps.git"
REPO_DIR="$HOME/rutapps"
TV_LIST_FILE="$HOME/.tv_list"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ADB
check_and_install_adb() {
    if ! command -v adb &> /dev/null; then
        echo "ADB –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∫–∞..."
        apt update > /dev/null 2>&1 && apt --assume-yes install wget > /dev/null 2>&1
        wget https://github.com/MasterDevX/Termux-ADB/raw/master/InstallTools.sh -q
        bash InstallTools.sh
        rm InstallTools.sh
        if command -v adb &> /dev/null; then
            echo "ADB —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        else
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ADB. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é."
            exit 1
        fi
    else
        echo "ADB —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
check_and_update_repo() {
    if [ -d "$REPO_DIR" ]; then
        echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
        cd "$REPO_DIR"
        git pull
        if [ $? -eq 0 ]; then
            echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω."
        else
            echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
            exit 1
        fi
    else
        echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        git clone "$REPO_URL" "$REPO_DIR"
        if [ $? -eq 0 ]; then
            echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω."
        else
            echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
            exit 1
        fi
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ APK —Ñ–∞–π–ª–æ–≤
show_apk_list() {
    echo "–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö APK —Ñ–∞–π–ª–æ–≤:"
    apk_files=($(ls "$REPO_DIR"/*.apk))
    for i in "${!apk_files[@]}"; do
        echo "$((i+1)). ${apk_files[$i]##*/}"
    done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ APK
install_apk() {
    while true; do
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä APK –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (0 –¥–ª—è –≤—ã—Ö–æ–¥–∞): " choice
        if [ $choice -eq 0 ]; then
            return
        elif [ $choice -le ${#apk_files[@]} ]; then
            selected_apk="${apk_files[$((choice-1))]}"
            echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ ${selected_apk##*/}..."
            adb install "$selected_apk"
            if [ $? -eq 0 ]; then
                echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ${selected_apk##*/} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
            else
                echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ${selected_apk##*/}."
            fi
        else
            echo "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä."
        fi
    done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é
show_menu() {
    clear
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           TV Manager              ‚ïë"
    echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
    echo "‚ïë 1. üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π     ‚ïë"
    echo "‚ïë 2. üì∫ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—É    ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
    echo
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1-2) –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ IP: " choice
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –¢–í
connect_to_tv() {
    local ip=$1
    adb connect $ip
    if [ $? -eq 0 ]; then
        # –î–æ–±–∞–≤–ª—è–µ–º IP –≤ —Å–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        if ! grep -q "^$ip$" "$TV_LIST_FILE"; then
            echo "$ip" >> "$TV_LIST_FILE"
        fi
        clear
        show_apk_list
        install_apk
    else
        echo "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ $ip"
        sleep 2
    fi
}

# –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–º —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–æ–≤
manage_tv_connection() {
    clear
    echo "üì∫ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—É"
    echo "------------------------"
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º –¢–í, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    touch "$TV_LIST_FILE"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—ã
    echo "–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä—ã:"
    if [ -s "$TV_LIST_FILE" ]; then
        cat "$TV_LIST_FILE" | nl
        echo
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –¢–í –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π IP: " tv_choice
        if [[ $tv_choice =~ ^[0-9]+$ ]] && [ $tv_choice -le $(wc -l < "$TV_LIST_FILE") ]; then
            tv_ip=$(sed -n "${tv_choice}p" "$TV_LIST_FILE")
            connect_to_tv $tv_ip
        else
            connect_to_tv $tv_choice
        fi
    else
        echo "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç"
        echo
        read -p "–í–≤–µ–¥–∏—Ç–µ IP-–∞–¥—Ä–µ—Å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞: " tv_ip
        connect_to_tv $tv_ip
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ADB –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
check_and_install_adb

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã
while true; do
    show_menu
    if [[ $choice =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        # –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω IP-–∞–¥—Ä–µ—Å
        connect_to_tv $choice
    else
        case $choice in
            1)
                clear
                echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π..."
                check_and_update_repo
                read -n 1 -s -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
                ;;
            2)
                manage_tv_connection
                ;;
            *)
                echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
                sleep 1
                ;;
        esac
    fi
done